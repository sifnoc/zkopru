version: '3'

services:
  testnet-geth:
    build:
      context: ./packages/contracts/
      dockerfile: ../../dockerfiles/Contract.geth.dockerfile
    ports:
      - '5000:5000'
    networks:
      default:
        ipv4_address: 172.30.1.2
        aliases: 
          - testnet
    command: >
      sh -c "set -x &&
      geth init --datadir data genesis.json &&
      geth account import testnet-key --password testnet-pass --datadir data &&
      geth --maxpeers 0 --fakepow --mine --miner.gasprice 1 --miner.threads 1 --miner.gastarget 12000000 --networkid 20200406 --datadir data --rpc --rpcaddr 0.0.0.0 --rpcport 5000 --rpccorsdomain '*' --rpc.allow-unprotected-txs --http.api eth,net,web3,personal,miner --unlock 90f8bf6a479f320ead074411a4b0e7944ea8c9c1 --password testnet-pass --allow-insecure-unlock --nousb &
      sleep 10 &&
      truffle migrate --network testnet  &&
      nc -w 10 coordinator 5354 &&
      tail -f /dev/null"
  coordinator:
    build:
      context: ./
      dockerfile: ./dockerfiles/Generator.dockerfile
    ports:
      - '8888:8888'
    networks:
      default:
        ipv4_address: 172.30.1.3
        aliases:
          - coordinator
    depends_on:
      - 'testnet-geth'
    environment:
      TARGET_HOST: 'testnet'
    command: >
      bash -c "nc -l -p 5354 &&
      nc -w 10 wallet 5354 && nc -w 10 depositer 5354 &&
      bash wait_deploy_contracts.sh &&
      node /proj/packages/coordinator/dist/cli.js --ws ws://testnet:5000 --config /proj/packages/coordinator/coordinator.json"
  depositer:
    build:
      context: ./
      dockerfile: ./dockerfiles/Generator.dockerfile
    environment:
      - DEFAULT_COORDINATOR=http://172.30.1.3:8888
    volumes:
      - './packages:/proj/packages'
    depends_on:
      - 'coordinator'
    command: bash -c "nc -l -p 5354 && sleep 60 && node /proj/packages/generator/dist/depositer.js"
  wallet:
    build:
      context: ./
      dockerfile: ./dockerfiles/Generator.dockerfile
    environment:
      - DEFAULT_COORDINATOR=http://172.30.1.3:8888
    volumes:
      - /run/docker.sock:/run/docker.sock:ro
      - './packages:/proj/packages'
    depends_on:
      - 'coordinator'
    command: > 
      bash -c "source get_name.sh &&
      nc -l -p 5354 &&
      bash wait_deploy_contracts && 
      sleep 15 && node /proj/packages/generator/dist/wallet.js"
  organizer:
    build:
      context: ./
      dockerfile: ./dockerfiles/Generator.dockerfile
    ports:
      - '8080:8080'
    volumes:
      - './packages:/proj/packages'
    depends_on:
      - 'wallet'
    command: bash -c "sleep 10 && node /proj/packages/generator/dist/organizer.js"

networks:
  default:
    ipam:
      config:
        - subnet: 172.30.1.0/24
